{% extends "base.html" %}

{% block content %}
<script id="user-data" type="application/json">
    {{ user|tojson }}
</script>

<div class="game-container">
    <div class="game-header">
        <h2>AI训练房间: {{ room.room_name }}</h2>
        <div class="game-info">
            <span id="game-stage">等待开始</span>
            <span id="pot-size">底池: 0</span>
        </div>
    </div>

    <div class="game-content">
        <!-- 主牌桌区域 -->
        <div class="main-table-section">
            <!-- 椭圆牌桌 -->
            <div id="table-stage">
                <div class="poker-table-container">
                    <div class="poker-table">
                        <!-- 公共牌显示在牌桌中间偏上位置 -->
                        <div id="community-cards-center" class="community-cards-center"></div>
                        <!-- 个人牌显示在牌桌下半侧 -->
                        <div id="player-hole-cards" class="player-hole-cards"></div>
                    </div>
                    <!-- 玩家围绕牌桌（移到牌桌容器外部） -->
                    <div id="players-container" class="players-around-table"></div>
                </div>
            </div>
            
            <!-- 游戏信息和控制区域 -->
            <div class="game-controls-section">
                <div class="game-status">
                    <span id="game-stage">等待开始</span>
                    <span id="pot-size">底池: 0</span>
                    <span id="ready-count">准备: 0/0</span>
                </div>
                
                <!-- 准备状态和操作按钮 -->
                <div class="action-buttons">
                    <!-- 准备按钮（游戏未开始时显示） -->
                    <div id="ready-section" class="ready-section">
                        <button id="ready-btn" class="action-btn btn-success">准备</button>
                        <button id="unready-btn" class="action-btn btn-secondary" style="display: none;">取消准备</button>
                        <button id="refresh-room-btn" class="action-btn btn-info" title="主动刷新房间玩家列表">刷新房间玩家</button>
                        <button id="reset-chips-btn" class="action-btn btn-warning" title="仅在未开局时可用">重置筹码</button>
                        <button id="reconnect-btn" class="action-btn btn-primary" style="display: none;" title="手动重连">重新连接</button>
                    </div>
                    
                    <!-- 游戏操作按钮（游戏开始时显示） -->
                    <div id="game-action-section" class="game-action-section" style="display: none;">
                        <button id="fold-btn" class="action-btn btn-danger">弃牌</button>
                        <button id="check-btn" class="action-btn btn-secondary">过牌</button>
                        <button id="call-btn" class="action-btn btn-primary">跟注</button>
                        <button id="allin-btn" class="action-btn btn-warning">全下</button>
                        
                        <div class="raise-section">
                            <input type="number" id="raise-amount" placeholder="加到的总注（raise-to）" min="0">
                            <span id="min-increment-hint" style="margin-left:8px;color:#fff;opacity:0.9;font-size:14px;"></span>
                            <button id="raise-btn" class="action-btn btn-warning">加注</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
    </div>
</div>

<!-- 游戏状态指示器 -->
<div id="connection-status" class="connection-status hidden">
    <div class="status-indicator"></div>
    <span>连接状态</span>
</div>

<!-- Toast 容器 -->
<div id="toast-container" class="toast-container"></div>

<!-- 摊牌浮层结构：显示时给 #showdown-overlay 添加 active 类 -->
<div class="showdown-overlay" id="showdown-overlay">
  <div class="showdown-dialog">
    <div class="showdown-title">摊牌</div>
    <div class="showdown-content">请确认是否摊牌</div>
    <div class="showdown-actions">
      <button class="showdown-btn showdown-btn-primary" id="showdown-confirm">确认摊牌</button>
      <button class="showdown-btn showdown-btn-secondary" id="showdown-cancel">取消</button>
    </div>
  </div>
</div>

<!-- 单玩家弹窗结构 -->
<div class="single-player-overlay" id="single-player-overlay">
  <div class="single-player-dialog">
    <div class="single-player-title">仅剩您一名玩家</div>
    <div class="single-player-content">
      <p>其他玩家已离开游戏，您想如何处理？</p>
      <p class="single-player-hint">
        <span id="single-player-countdown">20</span>秒后自动结束游戏
      </p>
    </div>
    <div class="single-player-actions">
      <button class="single-player-btn single-player-btn-warning" id="single-player-immediate-end">立即结束</button>
    </div>
  </div>
</div>


<script src="{{ url_for('static', path='js/game.js') }}?v=1.5"></script>
<script>
    // 极简认证 - 只使用cookie（符合技术方案）
    console.log('页面加载，检查cookie认证状态');
    console.log('当前cookie:', document.cookie);
    
    // 简单的cookie检查
    const sessionToken = document.cookie.match(/session_token=([^;]+)/)?.[1];
    console.log('从cookie获取的sessionToken:', sessionToken);
    
    if (!sessionToken) {
        console.warn('未找到session_token cookie，重定向到首页');
        // 添加延迟以确保cookie有足够时间设置
        setTimeout(() => {
            const retryToken = document.cookie.match(/session_token=([^;]+)/)?.[1];
            if (!retryToken) {
                window.location.href = '/';
            }
        }, 100);
    }
    
    // 添加详细的调试信息
    console.log('游戏页面加载完成，检查DOM元素:');
    console.log('ready-btn元素:', document.getElementById('ready-btn'));
    console.log('unready-btn元素:', document.getElementById('unready-btn'));
    console.log('players-container元素:', document.getElementById('players-container'));
    console.log('user数据:', document.getElementById('user-data')?.textContent);
    
    // 检查WebSocket连接状态
    setTimeout(() => {
        if (window.game && window.game.socket) {
            console.log('WebSocket连接状态:', window.game.socket.readyState);
            console.log('WebSocket URL:', window.game.socket.url);
        } else {
            console.log('WebSocket未初始化或game对象不存在');
        }
    }, 2000);
</script>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', path='css/game.css') }}?v=1.4">
<link rel="stylesheet" href="{{ url_for('static', path='css/mobile.css') }}?v=1.0">
{% endblock %}